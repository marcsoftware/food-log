<!DOCTYPE html>
<html>
<title>fitbsadfdsait</title>
<meta charset="UTF-8">
<style>
   .block{
        background-color: lightblue;
        color:black;
        display: inline-block;
        margin-bottom : 1px;
        margin-right: 1px;
        margin-top:0px;
        white-space: nowrap;
      }
</style>
<script>


var database_url='http://localhost:5000/demo';
//--------------------------------------------------------------------------------------------------------------------------------
//
//--------------------------------------------------------------------------------------------------------------------------------
function init(){
  var authcode= localStorage.getItem("authcode");
  document.getElementById('authcode').value=authcode;
  getHeartToday(authcode);
  
  //parse();
}


//--------------------------------------------------------------------------------------------------------------------------------
//
//--------------------------------------------------------------------------------------------------------------------------------
function test(){
    var authcode= localStorage.getItem("authcode");
    console.log(authcode);
    getHeartToday(authcode);
}




//--------------------------------------------------------------------------------------------------------------------------------
//
//--------------------------------------------------------------------------------------------------------------------------------
    function getHeartToday(token){

      
      
      var xhttp = new XMLHttpRequest();
      

      
      xhttp.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
            var object =  JSON.parse(this.responseText);
            alert(this.responseText);
            document.getElementById("json").value = this.responseText;
            
          
        }else{
          console.log( this.responseText);
        }
      };

      var end_date = getDateFormat(-30);
//https://api.fitbit.com/1/user/-/activities/heart/date/today/1d/1min.json
      xhttp.open("GET", `https://api.fitbit.com/1/user/-/activities/heart/date/today/${end_date}/1min.json`, true);
      xhttp.setRequestHeader('Authorization', 'Bearer '+token); // THIS is base64 of id and another thing.


      xhttp.send();


    }


/**
//---------------------------------------------------------------------
// 
//---------------------------------------------------------------------
*/
function getDateFormat(offset){
  var target_date = new Date();

    target_date.setDate(target_date.getDate()+offset);

    var dd = String(target_date.getDate()).padStart(2, '0');
    var mm = String(target_date.getMonth() + 1).padStart(2, '0'); 
    var yyyy = target_date.getFullYear();

    
    target_date = yyyy + '-' + mm + '-' + dd;
    return target_date;
}


/**
//---------------------------------------------------------------------
//
//---------------------------------------------------------------------
*/
var ONE_POUND_FAT=3500; // 1 pound of fat is 3500 calories
var VIEW_WIDTH=3000;
var BASE_CALORIES=2000; // calories burned per day by user
function combineData(){
  var table_rows=[];
  var calorie_total=0;
  var hand= document.getElementById('master');
    for(var i in foodlog_master){
     
      var row='<tr>';
      //table_rows+=foodlog_master[i]['calories'];
      if(fitbit_master[i] === undefined){

        fitbit_master[i] ={"minutes":0 , "calories":0} ;
      }


      var shrink=VIEW_WIDTH;
      var food_burn= parseInt(BASE_CALORIES- foodlog_master[i]['calories']);
      var fitbit_burn=parseInt(fitbit_master[i]['calories']);
      var total_burn=parseInt(food_burn+0+fitbit_burn);
      calorie_total+=parseInt(total_burn);
      var x_css='';
      var y_css='';
      var z_css='';

      if(food_burn < 0){
          x_css=' right ';
      }

      if(fitbit_burn < 0){
          y_css=' right ';
      }
      if(total_burn < 0){
          z_css=' right ';
      }
      var x= food_burn;
      var y=fitbit_burn;
      var z= total_burn;
      row+=`<th class='date'>${i} </th>
                   <th> <div class="block ${x_css}" style="width:${Math.abs((x)/shrink*100)}%" >  ${x}</div>  </th>
                   <th> <div class="block ${y_css}" style="width:${Math.abs((y)/shrink*100)}%" >   ${y} </div> </th>
                    <th> <div class="block ${z_css}" style="width:${Math.abs((z)/shrink*100)}%" >   ${z} </di1/v> </th>`;
                   
     row+='</tr>';
     table_rows.push(row);
     
      

    }
   
    document.getElementById('master_total').innerHTML=`${calorie_total}cals = ${(calorie_total/ONE_POUND_FAT).toFixed(2)}pounds`;
    hand.innerHTML='<table>'+table_rows.join('')+'</table>' ;

}


    //--------------------------------------------------------------------------------------------------------------------------------
    //
    //--------------------------------------------------------------------------------------------------------------------------------
    var fitbit_master = {};
    function getMinutes(id){
        var json=document.getElementById('json').value;
        json= JSON.parse(json);

        try{
          var date = json['activities-heart'][id]['dateTime'];
          var fatburnZone = json['activities-heart'][id]['value']['heartRateZones'][1];
          var cardioZone = json['activities-heart'][id]['value']['heartRateZones'][2];
          var peakZone = json['activities-heart'][id]['value']['heartRateZones'][3];
        }catch(e){
            return [0,0,0];
        }
        var fieldName = 'caloriesOut';
        var totalCalories=parseInt(fatburnZone[fieldName])+parseInt(cardioZone[fieldName])+parseInt(peakZone[fieldName]);
        totalCalories=totalCalories|| 0;
         fieldName = 'minutes';
        var totalMinutes=parseInt(fatburnZone[fieldName])+parseInt(cardioZone[fieldName])+parseInt(peakZone[fieldName]);
totalMinutes=totalMinutes|| 0;

        var record =  {"minutes":totalMinutes , "calories":totalCalories}  ;
        
        fitbit_master[date]=record;
        
        return [date,totalMinutes,totalCalories]
     
    }


  

     //--------------------------------------------------------------------------------------------------------------------------------
    //
    //--------------------------------------------------------------------------------------------------------------------------------
    function output(x){
        document.getElementById('total2').innerHTML+=x;
    }


 //--------------------------------------------------------------------------------------------------------------------------------
    //
    //--------------------------------------------------------------------------------------------------------------------------------
    var ONE_POUND_FAT=3500;
    function parse(){
      //setCookie('raw',document.getElementById('json').value);
        localStorage.setItem("raw", document.getElementById('json').value);
        document.getElementById('total2').innerHTML='';
       var totalCal=0;
       var totalMinutes=0;
       var new_json= JSON.parse(document.getElementById('json').value)['activities-heart'];
      var container=[];
      for(let i in new_json){
          
          var list = getMinutes(i);
          totalCal+=parseInt(list[2]);
          totalMinutes+=parseInt(list[1]);
          container.push(`${list[0]} <p class='block' style='width:${list[2]/2}px'>${list[2]} | ${list[1]} ( ${Math.round(list[2]/list[1])})</p><br/>`);
          
          
      }

      output(container.reverse().join(''));
      var totalHours = Math.floor(totalMinutes/60);
      var remainder = totalMinutes%60;
      document.getElementById('burned').innerHTML=totalHours+'h '+remainder+'m ';
      document.getElementById('burned').innerHTML+=totalCal+'calories ';
      document.getElementById('burned').innerHTML+=Math.round(totalCal/ONE_POUND_FAT).toFixed(2)+'pounds ';
    }



/**
//---------------------------------------------------------------------
//
//---------------------------------------------------------------------
*/
var foodlog_master= {};
function drawGraph(){
    var handle = document.getElementById('graph');
    var total=0;
    for(var i =0;i<avg_array.length;i++){
      var date = getDateFormat(0-i);
      var date_format = getDateFormat2(0-i);
      var width=avg_array[i]/8;
      var number =avg_array[i];
      total+=parseInt(number);
      handle.innerHTML+=date_format+' '+`<div class="block" style="width:${width}px">${number}</div><br/>`;
      foodlog_master[date_format]= { "calories":number } ;

    }

    var metabolism=2000; // calorie burn perday;
    var total_metabolism = metabolism*avg_array.length;
    var burned = total_metabolism-total;
    var text = ['gained','burned'];
    var isPositive=1;
    if(burned <=0){
        isPositive=0;
    }
    document.getElementById('total').innerHTML=`   ${burned} calories ${text[isPositive]} ${(burned/ONE_POUND_FAT)} pounds ${text[isPositive]}?  `;

}

/**
//---------------------------------------------------------------------
//
//---------------------------------------------------------------------
*/
// TODO get rid of other date functions REFACTOR
function getWeekCalories(){

    getCalorieArray();
    var days;
    // get last 7 days not including today
    days = avg_array.slice(1,6);

    document.getElementById('average7').innerHTML=getAverage(days);
       
    days = avg_array.slice(1,30);
    document.getElementById('average30').innerHTML=getAverage(days);   
  
    days = avg_array.slice(0,6);
    
    document.getElementById('average7today').innerHTML=getAverage(days); 
    
}


/**
//---------------------------------------------------------------------
// put day calories totals from the last 30 days.
//---------------------------------------------------------------------
*/
function getCalorieArray(){
    for(var i =0;i<=30;i++){
        
    
        var target_date = getDateFormat(0-i);
        getTotalSmart(target_date);
       

    }
}


</script>

<body>



</head>
<body>
<h2>MASTER</h2>
<div id='master_total'></div>
<div id='master'></div>

<h2>FITBIT REPORT</h2>
<p id='results' >EMPTY</p>
<p id='error' >EMPTY</p>
<textarea id='json'>
  

</textarea>
<button onclick="parse()">parse</button> 
<button onclick="test()">test</button> 
<p id='burned' >EMPTY</p>
<div id='total2'>total</div>
 
 

<h2>FOOD REPORT</h2>



           <p id='stats'></p>
           <div id='average30'>average30</div>  
           <div id='average7'>history</div>
           <div id='average7today'>average</div> 
           <div >---</div>
           <div id='total'>total</div>
 
<div id='debug'></div>  

    </div>


<div id='graph'></div>
</body>
</html>
