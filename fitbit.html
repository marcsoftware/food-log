<!DOCTYPE html>
<html>

<meta charset="UTF-8">
<style>
   .block{
        background-color: lightblue;
        color:black;
        display: inline-block;
        margin-bottom : 1px;
        margin-right: 1px;
        margin-top:0px;
        white-space: nowrap;
      }
</style>
<script>


//--------------------------------------------------------------------------------------------------------------------------------
//
//--------------------------------------------------------------------------------------------------------------------------------

    function getAuthCode() {
      
        var code=document.getElementById('code').value;
        var xhttp = new XMLHttpRequest();
      

      
      xhttp.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
            var token =  JSON.parse(this.responseText).access_token;
            document.cookie = "token="+token+"; expires=Thu, 18 Dec 5013 12:00:00 UTC" ; 
            setCookie("token",token);
          document.getElementById("authcode").value = token;
          getHeartToday(token);
      };

      

      xhttp.open("POST", "https://api.fitbit.com/oauth2/token?code="+code+"&grant_type=authorization_code&redirect_uri=http://localhost", true);
      xhttp.setRequestHeader('Authorization', 'Basic MjJCVlpDOmRjMTFjNzYwNTA4MjRmYjUwMWRjODhmNWRjYzRlOWE0'); // THIS is base64 of id and another thing.
      xhttp.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');

      xhttp.send();
    }
}
//--------------------------------------------------------------------------------------------------------------------------------
//
//--------------------------------------------------------------------------------------------------------------------------------
    function getHeartToday(token){

        if(token==='none'){
            token=getCookie("token");
        }


      var code=document.getElementById('code').value;
      var xhttp = new XMLHttpRequest();
      

      
      xhttp.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
            var object =  JSON.parse(this.responseText);
            document.getElementById("results").value = this.responseText;
          
        }else{
        	document.getElementById("error").innerHTML = this.responseText;
        }
      };

      
//https://api.fitbit.com/1/user/-/activities/heart/date/today/1d/1min.json
      xhttp.open("GET", "https://api.fitbit.com/1/user/-/activities/heart/date/today/1d/1min.json", true);
      xhttp.setRequestHeader('Authorization', 'Bearer '+token); // THIS is base64 of id and another thing.


      xhttp.send();


    }

    //--------------------------------------------------------------------------------------------------------------------------------
    //
    //--------------------------------------------------------------------------------------------------------------------------------

    function setCookie(cname, cvalue) {
          var d = new Date();
          d.setTime(d.getTime() + (10000*24*60*60*1000));
          var expires = "expires="+ d.toUTCString();
          document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
    }

    //--------------------------------------------------------------------------------------------------------------------------------
    //
    //--------------------------------------------------------------------------------------------------------------------------------
    function getCookie(cname) {
      var name = cname + "=";
      var decodedCookie = decodeURIComponent(document.cookie);
      var ca = decodedCookie.split(';');
      for(var i = 0; i <ca.length; i++) {
        var c = ca[i];
        while (c.charAt(0) == ' ') {
          c = c.substring(1);
        }
        if (c.indexOf(name) == 0) {
            document.getElementById('authcode').value=c.substring(name.length, c.length);
          return c.substring(name.length, c.length);
        }
      }
      return "";
    }

    //--------------------------------------------------------------------------------------------------------------------------------
    //
    //--------------------------------------------------------------------------------------------------------------------------------
    function parse(){
      
       var totalCal=0;
       var totalMinutes=0;

      for(var i = 30;i>=0;i--){
          var list = getMinutes(i);
          totalCal+=parseInt(list[2]);
          totalMinutes+=parseInt(list[1]);
          output(`${list[0]} <p class='block' style='width:${list[2]/2}px'>${list[2]} | ${list[1]} ( ${Math.round(list[2]/list[1])})</p><br/>`);
          
      }

      var totalHours = Math.floor(totalMinutes/60);
      var remainder = totalMinutes%60;
      document.getElementById('burned').innerHTML=totalHours+'h '+remainder+'m ';
      document.getElementById('burned').innerHTML+=totalCal+'calories ';
      document.getElementById('burned').innerHTML+=Math.round(totalCal/3000).toFixed(2)+'pounds ';
    }

    //--------------------------------------------------------------------------------------------------------------------------------
    //
    //--------------------------------------------------------------------------------------------------------------------------------
    function getMinutes(id){
        var json=document.getElementById('json').value;
        json= JSON.parse(json);

        try{
          var date = json['activities-heart'][id]['dateTime'];
          var fatburnZone = json['activities-heart'][id]['value']['heartRateZones'][1];
          var cardioZone = json['activities-heart'][id]['value']['heartRateZones'][2];
          var peakZone = json['activities-heart'][id]['value']['heartRateZones'][3];
        }catch(e){
            return [0,0,0];
        }
        var fieldName = 'caloriesOut';
        var totalCalories=parseInt(fatburnZone[fieldName])+parseInt(cardioZone[fieldName])+parseInt(peakZone[fieldName]);
        totalCalories=totalCalories|| 0;
         fieldName = 'minutes';
        var totalMinutes=parseInt(fatburnZone[fieldName])+parseInt(cardioZone[fieldName])+parseInt(peakZone[fieldName]);
totalMinutes=totalMinutes|| 0;
        
        return [date,totalMinutes,totalCalories]
     
    }

/**
//---------------------------------------------------------------------
//
//---------------------------------------------------------------------
*/
function getSum(some_array){
  
   var grades = some_array;
  
    var total = 0;
    for(var i = 0; i < grades.length; i++) {
      var number = parseFloat(grades[i]);
         total +=  number;
    }
    
    
    return total;
}


    //--------------------------------------------------------------------------------------------------------------------------------
    //
    //--------------------------------------------------------------------------------------------------------------------------------
    function output(x){
        document.getElementById('total').innerHTML+=x;
    }

</script>

<body>

<a href="https://www.fitbit.com/oauth2/authorize?response_type=code&client_id=22BVZC&redirect_uri=http://localhost&scope=activity%20nutrition%20heartrate%20location%20nutrition%20profile%20settings%20sleep%20social%20weight">url for code</a>

<input type="text" id='code' /><br/>

 <button onclick="getAuthCode()">get auth code</button> <br/>
 <textarea id='authcode'>  EMPTY</textarea><br/>

 <button onclick="getHeartToday('none')">get heart</button> <br/>
 <textarea id='results' >EMPTY</textarea>
 <p id='error' >error</p>
<textarea id='json'>
  
{
  "activities-heart": [
    {
      "dateTime": "2020-08-01",
      "value": {
        "customHeartRateZones": [],
        "heartRateZones": [
          {
            "caloriesOut": 2516.4471,
            "max": 100,
            "min": 30,
            "minutes": 1273,
            "name": "Out of Range"
          },
          {
            "caloriesOut": 538.04235,
            "max": 140,
            "min": 100,
            "minutes": 67,
            "name": "Fat Burn"
          },
          {
            "caloriesOut": 0,
            "max": 170,
            "min": 140,
            "minutes": 0,
            "name": "Cardio"
          },
          {
            "caloriesOut": 0,
            "max": 220,
            "min": 170,
            "minutes": 0,
            "name": "Peak"
          }
        ],
        "restingHeartRate": 56
      }
    },
    {
      "dateTime": "2020-08-02",
      "value": {
        "customHeartRateZones": [],
        "heartRateZones": [
          {
            "caloriesOut": 2115.36152,
            "max": 100,
            "min": 30,
            "minutes": 907,
            "name": "Out of Range"
          },
          {
            "caloriesOut": 248.03936,
            "max": 140,
            "min": 100,
            "minutes": 32,
            "name": "Fat Burn"
          },
          {
            "caloriesOut": 0,
            "max": 170,
            "min": 140,
            "minutes": 0,
            "name": "Cardio"
          },
          {
            "caloriesOut": 0,
            "max": 220,
            "min": 170,
            "minutes": 0,
            "name": "Peak"
          }
        ],
        "restingHeartRate": 56
      }
    },
    {
      "dateTime": "2020-08-03",
      "value": {
        "customHeartRateZones": [],
        "heartRateZones": [
          {
            "caloriesOut": 2248.44656,
            "max": 100,
            "min": 30,
            "minutes": 1199,
            "name": "Out of Range"
          },
          {
            "caloriesOut": 1401.37512,
            "max": 140,
            "min": 100,
            "minutes": 158,
            "name": "Fat Burn"
          },
          {
            "caloriesOut": 12.05008,
            "max": 170,
            "min": 140,
            "minutes": 1,
            "name": "Cardio"
          },
          {
            "caloriesOut": 0,
            "max": 220,
            "min": 170,
            "minutes": 0,
            "name": "Peak"
          }
        ],
        "restingHeartRate": 57
      }
    },
    {
      "dateTime": "2020-08-04",
      "value": {
        "customHeartRateZones": [],
        "heartRateZones": [
          {
            "caloriesOut": 2497.9324,
            "max": 100,
            "min": 30,
            "minutes": 1214,
            "name": "Out of Range"
          },
          {
            "caloriesOut": 94.80216,
            "max": 140,
            "min": 100,
            "minutes": 14,
            "name": "Fat Burn"
          },
          {
            "caloriesOut": 0,
            "max": 170,
            "min": 140,
            "minutes": 0,
            "name": "Cardio"
          },
          {
            "caloriesOut": 0,
            "max": 220,
            "min": 170,
            "minutes": 0,
            "name": "Peak"
          }
        ],
        "restingHeartRate": 57
      }
    },
    {
      "dateTime": "2020-08-05",
      "value": {
        "customHeartRateZones": [],
        "heartRateZones": [
          {
            "caloriesOut": 1443.30448,
            "max": 100,
            "min": 30,
            "minutes": 971,
            "name": "Out of Range"
          },
          {
            "caloriesOut": 288.83304,
            "max": 140,
            "min": 100,
            "minutes": 31,
            "name": "Fat Burn"
          },
          {
            "caloriesOut": 488.1512,
            "max": 170,
            "min": 140,
            "minutes": 39,
            "name": "Cardio"
          },
          {
            "caloriesOut": 497.00432,
            "max": 220,
            "min": 170,
            "minutes": 32,
            "name": "Peak"
          }
        ],
        "restingHeartRate": 57
      }
    },
    {
      "dateTime": "2020-08-06",
      "value": {
        "customHeartRateZones": [],
        "heartRateZones": [
          {
            "caloriesOut": 2869.29672,
            "max": 100,
            "min": 30,
            "minutes": 1168,
            "name": "Out of Range"
          },
          {
            "caloriesOut": 886.53628,
            "max": 140,
            "min": 100,
            "minutes": 104,
            "name": "Fat Burn"
          },
          {
            "caloriesOut": 0,
            "max": 170,
            "min": 140,
            "minutes": 0,
            "name": "Cardio"
          },
          {
            "caloriesOut": 0,
            "max": 220,
            "min": 170,
            "minutes": 0,
            "name": "Peak"
          }
        ],
        "restingHeartRate": 56
      }
    },
    {
      "dateTime": "2020-08-07",
      "value": {
        "customHeartRateZones": [],
        "heartRateZones": [
          {
            "caloriesOut": 1540.484,
            "max": 100,
            "min": 30,
            "minutes": 960,
            "name": "Out of Range"
          },
          {
            "caloriesOut": 167.2946,
            "max": 140,
            "min": 100,
            "minutes": 23,
            "name": "Fat Burn"
          },
          {
            "caloriesOut": 0,
            "max": 170,
            "min": 140,
            "minutes": 0,
            "name": "Cardio"
          },
          {
            "caloriesOut": 0,
            "max": 220,
            "min": 170,
            "minutes": 0,
            "name": "Peak"
          }
        ],
        "restingHeartRate": 54
      }
    },
    {
      "dateTime": "2020-08-08",
      "value": {
        "customHeartRateZones": [],
        "heartRateZones": [
          {
            "caloriesOut": 1411.2109,
            "max": 100,
            "min": 30,
            "minutes": 749,
            "name": "Out of Range"
          },
          {
            "caloriesOut": 26.12445,
            "max": 140,
            "min": 100,
            "minutes": 3,
            "name": "Fat Burn"
          },
          {
            "caloriesOut": 0,
            "max": 170,
            "min": 140,
            "minutes": 0,
            "name": "Cardio"
          },
          {
            "caloriesOut": 0,
            "max": 220,
            "min": 170,
            "minutes": 0,
            "name": "Peak"
          }
        ],
        "restingHeartRate": 54
      }
    },
    {
      "dateTime": "2020-08-09",
      "value": {
        "customHeartRateZones": [],
        "heartRateZones": [
          {
            "caloriesOut": 2147.44552,
            "max": 100,
            "min": 30,
            "minutes": 1289,
            "name": "Out of Range"
          },
          {
            "caloriesOut": 21.74128,
            "max": 140,
            "min": 100,
            "minutes": 3,
            "name": "Fat Burn"
          },
          {
            "caloriesOut": 0,
            "max": 170,
            "min": 140,
            "minutes": 0,
            "name": "Cardio"
          },
          {
            "caloriesOut": 0,
            "max": 220,
            "min": 170,
            "minutes": 0,
            "name": "Peak"
          }
        ],
        "restingHeartRate": 54
      }
    },
    {
      "dateTime": "2020-08-10",
      "value": {
        "customHeartRateZones": [],
        "heartRateZones": [
          {
            "caloriesOut": 1542.1698,
            "max": 100,
            "min": 30,
            "minutes": 886,
            "name": "Out of Range"
          },
          {
            "caloriesOut": 153.90768,
            "max": 140,
            "min": 100,
            "minutes": 19,
            "name": "Fat Burn"
          },
          {
            "caloriesOut": 0,
            "max": 170,
            "min": 140,
            "minutes": 0,
            "name": "Cardio"
          },
          {
            "caloriesOut": 0,
            "max": 220,
            "min": 170,
            "minutes": 0,
            "name": "Peak"
          }
        ],
        "restingHeartRate": 55
      }
    },
    {
      "dateTime": "2020-08-11",
      "value": {
        "customHeartRateZones": [],
        "heartRateZones": [
          {
            "caloriesOut": 2287.62642,
            "max": 100,
            "min": 30,
            "minutes": 1226,
            "name": "Out of Range"
          },
          {
            "caloriesOut": 212.62956,
            "max": 140,
            "min": 100,
            "minutes": 25,
            "name": "Fat Burn"
          },
          {
            "caloriesOut": 0,
            "max": 170,
            "min": 140,
            "minutes": 0,
            "name": "Cardio"
          },
          {
            "caloriesOut": 0,
            "max": 220,
            "min": 170,
            "minutes": 0,
            "name": "Peak"
          }
        ],
        "restingHeartRate": 55
      }
    },
    {
      "dateTime": "2020-08-12",
      "value": {
        "customHeartRateZones": [],
        "heartRateZones": [
          {
            "caloriesOut": 1028.2922,
            "max": 100,
            "min": 30,
            "minutes": 628,
            "name": "Out of Range"
          },
          {
            "caloriesOut": 1068.2738,
            "max": 140,
            "min": 100,
            "minutes": 111,
            "name": "Fat Burn"
          },
          {
            "caloriesOut": 74.5336,
            "max": 170,
            "min": 140,
            "minutes": 6,
            "name": "Cardio"
          },
          {
            "caloriesOut": 0,
            "max": 220,
            "min": 170,
            "minutes": 0,
            "name": "Peak"
          }
        ],
        "restingHeartRate": 57
      }
    },
    {
      "dateTime": "2020-08-13",
      "value": {
        "customHeartRateZones": [],
        "heartRateZones": [
          {
            "caloriesOut": 1294.69998,
            "max": 100,
            "min": 30,
            "minutes": 828,
            "name": "Out of Range"
          },
          {
            "caloriesOut": 558.7302,
            "max": 140,
            "min": 100,
            "minutes": 57,
            "name": "Fat Burn"
          },
          {
            "caloriesOut": 0,
            "max": 170,
            "min": 140,
            "minutes": 0,
            "name": "Cardio"
          },
          {
            "caloriesOut": 0,
            "max": 220,
            "min": 170,
            "minutes": 0,
            "name": "Peak"
          }
        ],
        "restingHeartRate": 55
      }
    },
    {
      "dateTime": "2020-08-14",
      "value": {
        "customHeartRateZones": [],
        "heartRateZones": [
          {
            "caloriesOut": 522.84672,
            "max": 100,
            "min": 30,
            "minutes": 244,
            "name": "Out of Range"
          },
          {
            "caloriesOut": 421.71846,
            "max": 140,
            "min": 100,
            "minutes": 46,
            "name": "Fat Burn"
          },
          {
            "caloriesOut": 50.50224,
            "max": 170,
            "min": 140,
            "minutes": 4,
            "name": "Cardio"
          },
          {
            "caloriesOut": 0,
            "max": 220,
            "min": 170,
            "minutes": 0,
            "name": "Peak"
          }
        ],
        "restingHeartRate": 56
      }
    },
    {
      "dateTime": "2020-08-15",
      "value": {
        "customHeartRateZones": [],
        "heartRateZones": [
          {
            "caloriesOut": 168.74198,
            "max": 100,
            "min": 30,
            "minutes": 61,
            "name": "Out of Range"
          },
          {
            "caloriesOut": 0,
            "max": 140,
            "min": 100,
            "minutes": 0,
            "name": "Fat Burn"
          },
          {
            "caloriesOut": 0,
            "max": 170,
            "min": 140,
            "minutes": 0,
            "name": "Cardio"
          },
          {
            "caloriesOut": 0,
            "max": 220,
            "min": 170,
            "minutes": 0,
            "name": "Peak"
          }
        ]
      }
    }
  ]
}

</textarea>
 <button onclick="parse()">parse</button> 
 <p id='burned' >EMPTY</p>
 <p id='total' ></p>
</body>
</html>
