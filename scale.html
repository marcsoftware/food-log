<!DOCTYPE html>
<html>
<title>SCALE</title>
<meta charset="UTF-8">
<style>
   .block{
        background-color: lightblue;
        color:black;
        display: inline-block;
        margin-bottom : 1px;
        margin-right: 1px;
        margin-top:0px; 
        white-space: nowrap;
      }
</style>
<script>

window.onload=init;

//--------------------------------------------------------------------------------------------------------------------------------
//
//--------------------------------------------------------------------------------------------------------------------------------
function init(){
  
  
  test();
  
  //parse();
}


//--------------------------------------------------------------------------------------------------------------------------------
//
//--------------------------------------------------------------------------------------------------------------------------------
function test(){
    var authcode= localStorage.getItem("authcode");
    console.log(authcode);
    getScale(authcode);
}





//--------------------------------------------------------------------------------------------------------------------------------
//
//--------------------------------------------------------------------------------------------------------------------------------
    function getScale(token){


      
      var xhttp = new XMLHttpRequest();
      

      
      xhttp.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
            var object =  JSON.parse(this.responseText);
            
            document.getElementById("scale_results").value = this.responseText;
            parse();
          
        }else{
        	console.log( this.responseText);
        }
      };

      var end_date = getDateFormat(-30);
      
//https://api.fitbit.com/1/user/-/activities/heart/date/today/1d/1min.json
      xhttp.open("GET", `https://api.fitbit.com/1/user/-/activities/heart/date/today/${end_date}/1min.json`, true);
      xhttp.setRequestHeader('Authorization', 'Bearer '+token); // THIS is base64 of id and another thing.


      xhttp.send();


    }


/**
//---------------------------------------------------------------------
// 
//---------------------------------------------------------------------
*/
function getDateFormat(offset){
  var target_date = new Date();

    target_date.setDate(target_date.getDate()+offset);

    var dd = String(target_date.getDate()).padStart(2, '0');
    var mm = String(target_date.getMonth() + 1).padStart(2, '0'); 
    var yyyy = target_date.getFullYear();

    
    target_date = yyyy + '-' + mm + '-' + dd;
    return target_date;
}

    //--------------------------------------------------------------------------------------------------------------------------------
    //
    //--------------------------------------------------------------------------------------------------------------------------------
    var ONE_POUND_FAT=3500;
    function parse(){
      //setCookie('raw',document.getElementById('json').value);
        localStorage.setItem("raw", document.getElementById('scale_results').value);
        document.getElementById('total').innerHTML='';
       var totalCal=0;
       var totalMinutes=0;
       var new_json= JSON.parse(document.getElementById('scale_results').value)['activities-heart'];
      var container=[];
      for(let i in new_json){
          
          var list = getMinutes(i);
          totalCal+=parseInt(list[2]);
          totalMinutes+=parseInt(list[1]);
          container.push(`${list[0]} <p class='block' style='width:${list[2]/2}px'>${list[2]} | ${list[1]} ( ${Math.round(list[2]/list[1])})</p><br/>`);
          
          
      }
}
</script>

<body>


<input type="text" id='weight' /><br/>
<button onclick="test()">save</button> <br/>
 <button onclick="test()">test</button> <br/>
 <textarea id='scale_results'></textarea>
 
</body>
</html>
